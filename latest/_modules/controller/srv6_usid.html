

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>controller.srv6_usid &mdash; ROSE SRv6 Control Plane v0.1.0 documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home" alt="Documentation Home"> ROSE SRv6 Control Plane
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../controller/index.html">Controller</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../node-manager/index.html">Node Manager</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../release/index.html">Release Log</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../license.html">License</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">ROSE SRv6 Control Plane</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>controller.srv6_usid</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for controller.srv6_usid</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/python</span>

<span class="c1">##########################################################################</span>
<span class="c1"># Copyright (C) 2020 Carmine Scarpitta</span>
<span class="c1"># (Consortium GARR and University of Rome &quot;Tor Vergata&quot;)</span>
<span class="c1"># www.garr.it - www.uniroma2.it/netgroup</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &#39;License&#39;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1"># http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>
<span class="c1">#</span>
<span class="c1"># Implementation of SRv6 Controller</span>
<span class="c1">#</span>
<span class="c1"># @author Carmine Scarpitta &lt;carmine.scarpitta@uniroma2.it&gt;</span>
<span class="c1">#</span>


<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">Control-Plane functionalities for SRv6 Manager</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="c1"># General imports</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">pprint</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">ipaddress</span> <span class="kn">import</span> <span class="n">IPv6Address</span>

<span class="kn">from</span> <span class="nn">pyaml</span> <span class="kn">import</span> <span class="n">yaml</span>

<span class="c1"># Proto dependencies</span>
<span class="kn">import</span> <span class="nn">commons_pb2</span>
<span class="c1"># Controller dependencies</span>
<span class="kn">from</span> <span class="nn">controller</span> <span class="kn">import</span> <span class="n">srv6_utils</span>
<span class="kn">from</span> <span class="nn">controller</span> <span class="kn">import</span> <span class="n">utils</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">controller</span> <span class="kn">import</span> <span class="n">arangodb_driver</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ArangoDB modules not installed&#39;</span><span class="p">)</span>

<span class="c1"># Global variables definition</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># Logger reference</span>
<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">NOTSET</span><span class="p">)</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="c1"># Default number of bits for the SID Locator</span>
<span class="n">DEFAULT_LOCATOR_BITS</span> <span class="o">=</span> <span class="mi">32</span>
<span class="c1"># Default number of bits for the uSID identifier</span>
<span class="n">DEFAULT_USID_ID_BITS</span> <span class="o">=</span> <span class="mi">16</span>


<div class="viewcode-block" id="InvalidConfigurationError"><a class="viewcode-back" href="../../controller/api/srv6_usid.html#controller.srv6_usid.InvalidConfigurationError">[docs]</a><span class="k">class</span> <span class="nc">InvalidConfigurationError</span><span class="p">(</span><span class="n">srv6_utils</span><span class="o">.</span><span class="n">SRv6Exception</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Configuration file is not valid.</span>
<span class="sd">    &#39;&#39;&#39;</span></div>


<div class="viewcode-block" id="NodeNotFoundError"><a class="viewcode-back" href="../../controller/api/srv6_usid.html#controller.srv6_usid.NodeNotFoundError">[docs]</a><span class="k">class</span> <span class="nc">NodeNotFoundError</span><span class="p">(</span><span class="n">srv6_utils</span><span class="o">.</span><span class="n">SRv6Exception</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Node not found error.</span>
<span class="sd">    &#39;&#39;&#39;</span></div>


<div class="viewcode-block" id="TooManySegmentsError"><a class="viewcode-back" href="../../controller/api/srv6_usid.html#controller.srv6_usid.TooManySegmentsError">[docs]</a><span class="k">class</span> <span class="nc">TooManySegmentsError</span><span class="p">(</span><span class="n">srv6_utils</span><span class="o">.</span><span class="n">SRv6Exception</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Too many segments error.</span>
<span class="sd">    &#39;&#39;&#39;</span></div>


<div class="viewcode-block" id="SIDLocatorError"><a class="viewcode-back" href="../../controller/api/srv6_usid.html#controller.srv6_usid.SIDLocatorError">[docs]</a><span class="k">class</span> <span class="nc">SIDLocatorError</span><span class="p">(</span><span class="n">srv6_utils</span><span class="o">.</span><span class="n">SRv6Exception</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    SID Locator is invalid error.</span>
<span class="sd">    &#39;&#39;&#39;</span></div>


<div class="viewcode-block" id="InvalidSIDError"><a class="viewcode-back" href="../../controller/api/srv6_usid.html#controller.srv6_usid.InvalidSIDError">[docs]</a><span class="k">class</span> <span class="nc">InvalidSIDError</span><span class="p">(</span><span class="n">srv6_utils</span><span class="o">.</span><span class="n">SRv6Exception</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    SID is invalid.</span>
<span class="sd">    &#39;&#39;&#39;</span></div>


<div class="viewcode-block" id="print_nodes"><a class="viewcode-back" href="../../controller/api/srv6_usid.html#controller.srv6_usid.print_nodes">[docs]</a><span class="k">def</span> <span class="nf">print_nodes</span><span class="p">(</span><span class="n">nodes_dict</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Print the nodes.</span>

<span class="sd">    :param nodes_dict: Dict containing the nodes</span>
<span class="sd">    :type nodes_dict: dict</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">nodes_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span></div>


<div class="viewcode-block" id="print_node_to_addr_mapping"><a class="viewcode-back" href="../../controller/api/srv6_usid.html#controller.srv6_usid.print_node_to_addr_mapping">[docs]</a><span class="k">def</span> <span class="nf">print_node_to_addr_mapping</span><span class="p">(</span><span class="n">nodes_filename</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This function reads a YAML file containing the mapping</span>
<span class="sd">    of node names to IP addresses and pretty print it</span>

<span class="sd">    :param node_to_addr_filename: Name of the YAML file containing the</span>
<span class="sd">                                  mapping of node names to IP addresses</span>
<span class="sd">    :type node_to_addr_filename: str</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1"># Read the mapping from the file</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">nodes_filename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">nodes_file</span><span class="p">:</span>
        <span class="n">nodes</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">nodes_file</span><span class="p">)</span>
    <span class="c1"># Validate the IP addresses</span>
    <span class="k">for</span> <span class="n">addr</span> <span class="ow">in</span> <span class="p">[</span><span class="n">node</span><span class="p">[</span><span class="s1">&#39;grpc_ip&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;nodes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">utils</span><span class="o">.</span><span class="n">validate_ipv6_address</span><span class="p">(</span><span class="n">addr</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Invalid IPv6 address </span><span class="si">%s</span><span class="s1"> in </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
                         <span class="n">addr</span><span class="p">,</span> <span class="n">nodes_filename</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">InvalidConfigurationError</span>
    <span class="c1"># Validate the SIDs</span>
    <span class="k">for</span> <span class="n">sid</span> <span class="ow">in</span> <span class="p">[</span><span class="n">node</span><span class="p">[</span><span class="s1">&#39;uN&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;nodes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">utils</span><span class="o">.</span><span class="n">validate_ipv6_address</span><span class="p">(</span><span class="n">sid</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Invalid SID </span><span class="si">%s</span><span class="s1"> in </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
                         <span class="n">sid</span><span class="p">,</span> <span class="n">nodes_filename</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">InvalidConfigurationError</span>
    <span class="c1"># Validate the forwarding engine</span>
    <span class="k">for</span> <span class="n">fwd_engine</span> <span class="ow">in</span> <span class="p">[</span><span class="n">node</span><span class="p">[</span><span class="s1">&#39;fwd_engine&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;nodes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()]:</span>
        <span class="k">if</span> <span class="n">fwd_engine</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;linux&#39;</span><span class="p">,</span> <span class="s1">&#39;vpp&#39;</span><span class="p">,</span> <span class="s1">&#39;p4&#39;</span><span class="p">]:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Invalid forwarding engine </span><span class="si">%s</span><span class="s1"> in </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
                         <span class="n">fwd_engine</span><span class="p">,</span> <span class="n">nodes_filename</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">InvalidConfigurationError</span>
    <span class="c1"># Get the #bits of the locator</span>
    <span class="n">locator_bits</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;locator_bits&#39;</span><span class="p">)</span>
    <span class="c1"># Validate #bits for the SID Locator</span>
    <span class="k">if</span> <span class="n">locator_bits</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> \
            <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">locator_bits</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">int</span><span class="p">(</span><span class="n">locator_bits</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">128</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">InvalidConfigurationError</span>
    <span class="c1"># Get the #bits of the uSID identifier</span>
    <span class="n">usid_id_bits</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;usid_id_bits&#39;</span><span class="p">)</span>
    <span class="c1"># Validate #bits for the uSID ID</span>
    <span class="k">if</span> <span class="n">usid_id_bits</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> \
            <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">usid_id_bits</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">int</span><span class="p">(</span><span class="n">usid_id_bits</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">128</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">InvalidConfigurationError</span>
    <span class="k">if</span> <span class="n">locator_bits</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">usid_id_bits</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> \
            <span class="nb">int</span><span class="p">(</span><span class="n">usid_id_bits</span><span class="p">)</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">locator_bits</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">128</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">InvalidConfigurationError</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">List of available devices:&#39;</span><span class="p">)</span>
    <span class="n">pprint</span><span class="o">.</span><span class="n">PrettyPrinter</span><span class="p">(</span><span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">pprint</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;nodes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
    <span class="nb">print</span><span class="p">()</span></div>


<div class="viewcode-block" id="read_nodes"><a class="viewcode-back" href="../../controller/api/srv6_usid.html#controller.srv6_usid.read_nodes">[docs]</a><span class="k">def</span> <span class="nf">read_nodes</span><span class="p">(</span><span class="n">nodes_filename</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Convert a list of node names into a list of IP addresses.</span>

<span class="sd">    :param nodes_filename: Name of the YAML file containing the</span>
<span class="sd">                           IP addresses</span>
<span class="sd">    :type nodes_filename: str</span>
<span class="sd">    :return: Tuple (List of IP addresses, Locator bits, uSID ID bits)</span>
<span class="sd">    :rtype: tuple</span>
<span class="sd">    :raises NodeNotFoundError: Node name not found in the mapping file</span>
<span class="sd">    :raises InvalidConfigurationError: The mapping file is not a valid</span>
<span class="sd">                                       YAML file</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1"># Read the mapping from the file</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">nodes_filename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">nodes_file</span><span class="p">:</span>
        <span class="n">nodes</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">nodes_file</span><span class="p">)</span>
    <span class="c1"># Validate the IP addresses</span>
    <span class="k">for</span> <span class="n">addr</span> <span class="ow">in</span> <span class="p">[</span><span class="n">node</span><span class="p">[</span><span class="s1">&#39;grpc_ip&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;nodes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">utils</span><span class="o">.</span><span class="n">validate_ipv6_address</span><span class="p">(</span><span class="n">addr</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Invalid IPv6 address </span><span class="si">%s</span><span class="s1"> in </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
                         <span class="n">addr</span><span class="p">,</span> <span class="n">nodes_filename</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">InvalidConfigurationError</span>
    <span class="c1"># Validate the SIDs</span>
    <span class="k">for</span> <span class="n">sid</span> <span class="ow">in</span> <span class="p">[</span><span class="n">node</span><span class="p">[</span><span class="s1">&#39;uN&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;nodes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">utils</span><span class="o">.</span><span class="n">validate_ipv6_address</span><span class="p">(</span><span class="n">sid</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Invalid SID </span><span class="si">%s</span><span class="s1"> in </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
                         <span class="n">sid</span><span class="p">,</span> <span class="n">nodes_filename</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">InvalidConfigurationError</span>
    <span class="c1"># Validate the forwarding engine</span>
    <span class="k">for</span> <span class="n">fwd_engine</span> <span class="ow">in</span> <span class="p">[</span><span class="n">node</span><span class="p">[</span><span class="s1">&#39;fwd_engine&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;nodes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()]:</span>
        <span class="k">if</span> <span class="n">fwd_engine</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;linux&#39;</span><span class="p">,</span> <span class="s1">&#39;vpp&#39;</span><span class="p">,</span> <span class="s1">&#39;p4&#39;</span><span class="p">]:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Invalid forwarding engine </span><span class="si">%s</span><span class="s1"> in </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
                         <span class="n">fwd_engine</span><span class="p">,</span> <span class="n">nodes_filename</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">InvalidConfigurationError</span>
    <span class="c1"># Get the #bits of the locator</span>
    <span class="n">locator_bits</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;locator_bits&#39;</span><span class="p">)</span>
    <span class="c1"># Validate #bits for the SID Locator</span>
    <span class="k">if</span> <span class="n">locator_bits</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> \
            <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">locator_bits</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">int</span><span class="p">(</span><span class="n">locator_bits</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">128</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">InvalidConfigurationError</span>
    <span class="c1"># Get the #bits of the uSID identifier</span>
    <span class="n">usid_id_bits</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;usid_id_bits&#39;</span><span class="p">)</span>
    <span class="c1"># Validate #bits for the uSID ID</span>
    <span class="k">if</span> <span class="n">usid_id_bits</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> \
            <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">usid_id_bits</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">int</span><span class="p">(</span><span class="n">usid_id_bits</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">128</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">InvalidConfigurationError</span>
    <span class="k">if</span> <span class="n">locator_bits</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">usid_id_bits</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> \
            <span class="nb">int</span><span class="p">(</span><span class="n">usid_id_bits</span><span class="p">)</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">locator_bits</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">128</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">InvalidConfigurationError</span>
    <span class="c1"># Enforce case-sensitivity</span>
    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;nodes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;nodes&#39;</span><span class="p">][</span><span class="n">node</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]][</span><span class="s1">&#39;grpc_ip&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">node</span><span class="p">[</span><span class="s1">&#39;grpc_ip&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;nodes&#39;</span><span class="p">][</span><span class="n">node</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]][</span><span class="s1">&#39;uN&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">node</span><span class="p">[</span><span class="s1">&#39;uN&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="c1"># Return the nodes list</span>
    <span class="k">return</span> <span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;nodes&#39;</span><span class="p">],</span> <span class="n">locator_bits</span><span class="p">,</span> <span class="n">usid_id_bits</span></div>


<div class="viewcode-block" id="segments_to_micro_segment"><a class="viewcode-back" href="../../controller/api/srv6_usid.html#controller.srv6_usid.segments_to_micro_segment">[docs]</a><span class="k">def</span> <span class="nf">segments_to_micro_segment</span><span class="p">(</span><span class="n">locator</span><span class="p">,</span> <span class="n">segments</span><span class="p">,</span>
                              <span class="n">locator_bits</span><span class="o">=</span><span class="n">DEFAULT_LOCATOR_BITS</span><span class="p">,</span>
                              <span class="n">usid_id_bits</span><span class="o">=</span><span class="n">DEFAULT_USID_ID_BITS</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Convert a SID list (with #segments &lt;= 6) into a uSID.</span>

<span class="sd">    :param locator: The SID Locator of the segments.</span>
<span class="sd">                    All the segments must use the same SID Locator.</span>
<span class="sd">    :type locator: str</span>
<span class="sd">    :param segments: The SID List to be compressed</span>
<span class="sd">    :type segments: list</span>
<span class="sd">    :param locator_bits: Number of bits of the locator part of the SIDs</span>
<span class="sd">    :type locator_bits: int</span>
<span class="sd">    :param usid_id_bits: Number of bits of the uSID identifiers</span>
<span class="sd">    :type usid_id_bits: int</span>
<span class="sd">    :return: The uSID containing all the segments</span>
<span class="sd">    :rtype: str</span>
<span class="sd">    :raises TooManySegmentsError: segments arg contains too many segments</span>
<span class="sd">    :raises SIDLocatorError: SID Locator is wrong for one or more segments</span>
<span class="sd">    :raises InvalidSIDError: SID is wrong for one or more segments</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1"># Locator mask, used to extract the locator from the SIDs</span>
    <span class="c1">#</span>
    <span class="c1"># It is computed with a binary manipulation</span>
    <span class="c1"># We start from the IPv6 address 111...11111, then we put to zero</span>
    <span class="c1"># the bits of the non-locator part</span>
    <span class="c1"># The remaining part is the locator, which is converted to an IPv6Address</span>
    <span class="n">locator_mask</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">IPv6Address</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="s1">&#39;1&#39;</span> <span class="o">*</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">^</span>
                                   <span class="nb">int</span><span class="p">(</span><span class="s1">&#39;1&#39;</span> <span class="o">*</span> <span class="p">(</span><span class="mi">128</span> <span class="o">-</span> <span class="n">locator_bits</span><span class="p">),</span> <span class="mi">2</span><span class="p">)))</span>
    <span class="c1"># uSID identifier mask</span>
    <span class="c1">#</span>
    <span class="c1"># It is computed with a binary manipulation</span>
    <span class="c1"># We start from the IPv6 address 111...11111, then we perform a shift</span>
    <span class="c1"># operation</span>
    <span class="n">usid_id_mask</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">IPv6Address</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="s1">&#39;1&#39;</span> <span class="o">*</span> <span class="n">usid_id_bits</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
                                   <span class="p">(</span><span class="mi">128</span> <span class="o">-</span> <span class="n">locator_bits</span> <span class="o">-</span> <span class="n">usid_id_bits</span><span class="p">)))</span>
    <span class="c1"># Enforce case-sensitivity</span>
    <span class="n">locator</span> <span class="o">=</span> <span class="n">locator</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">_segments</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">segment</span> <span class="ow">in</span> <span class="n">segments</span><span class="p">:</span>
        <span class="n">_segments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">segment</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
    <span class="n">segments</span> <span class="o">=</span> <span class="n">_segments</span>
    <span class="c1"># Validation check</span>
    <span class="c1"># We need to verify if there is space in the uSID for all the segments</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">segments</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">((</span><span class="mi">128</span> <span class="o">-</span> <span class="n">locator_bits</span><span class="p">)</span> <span class="o">/</span> <span class="n">usid_id_bits</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Too many segments&#39;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">TooManySegmentsError</span>
    <span class="c1"># uSIDs always start with the SID Locator</span>
    <span class="n">usid_int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">IPv6Address</span><span class="p">(</span><span class="n">locator</span><span class="p">))</span>
    <span class="c1"># Offset of the uSIDs</span>
    <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># Iterate on the segments</span>
    <span class="k">for</span> <span class="n">segment</span> <span class="ow">in</span> <span class="n">segments</span><span class="p">:</span>
        <span class="c1"># Split the segment in...</span>
        <span class="c1"># ...segment locator</span>
        <span class="n">segment_locator</span> <span class="o">=</span> \
            <span class="nb">str</span><span class="p">(</span><span class="n">IPv6Address</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">IPv6Address</span><span class="p">(</span><span class="n">locator_mask</span><span class="p">))</span> <span class="o">&amp;</span>
                            <span class="nb">int</span><span class="p">(</span><span class="n">IPv6Address</span><span class="p">(</span><span class="n">segment</span><span class="p">))))</span>
        <span class="k">if</span> <span class="n">locator</span> <span class="o">!=</span> <span class="n">segment_locator</span><span class="p">:</span>
            <span class="c1"># All the segments must have the same Locator</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Wrong locator for the SID </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">segment</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">SIDLocatorError</span>
        <span class="c1"># ...and uSID identifier</span>
        <span class="n">usid_id</span> <span class="o">=</span> \
            <span class="nb">str</span><span class="p">(</span><span class="n">IPv6Address</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">IPv6Address</span><span class="p">(</span><span class="n">usid_id_mask</span><span class="p">))</span> <span class="o">&amp;</span>
                            <span class="nb">int</span><span class="p">(</span><span class="n">IPv6Address</span><span class="p">(</span><span class="n">segment</span><span class="p">))))</span>
        <span class="c1"># Other bits should be equal to zero</span>
        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">IPv6Address</span><span class="p">(</span><span class="n">segment</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span>
                <span class="mb">0b1</span> <span class="o">*</span> <span class="p">(</span><span class="mi">128</span> <span class="o">-</span> <span class="n">locator_bits</span> <span class="o">-</span> <span class="n">usid_id_bits</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># The SID is invalid</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;SID </span><span class="si">%s</span><span class="s1"> is invalid. Final bits should be zero&#39;</span><span class="p">,</span>
                         <span class="n">segment</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">InvalidSIDError</span>
        <span class="c1"># And append to the uSID</span>
        <span class="n">usid_int</span> <span class="o">+=</span> <span class="nb">int</span><span class="p">(</span><span class="n">IPv6Address</span><span class="p">(</span><span class="n">usid_id</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="n">offset</span>
        <span class="c1"># Increase offset</span>
        <span class="n">offset</span> <span class="o">+=</span> <span class="n">usid_id_bits</span>
    <span class="c1"># Get a string representation of the uSID</span>
    <span class="n">usid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">IPv6Address</span><span class="p">(</span><span class="n">usid_int</span><span class="p">))</span>
    <span class="c1"># Enforce case-sensitivity and return the uSID</span>
    <span class="k">return</span> <span class="n">usid</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span></div>


<div class="viewcode-block" id="get_sid_locator"><a class="viewcode-back" href="../../controller/api/srv6_usid.html#controller.srv6_usid.get_sid_locator">[docs]</a><span class="k">def</span> <span class="nf">get_sid_locator</span><span class="p">(</span><span class="n">sid_list</span><span class="p">,</span> <span class="n">locator_bits</span><span class="o">=</span><span class="n">DEFAULT_LOCATOR_BITS</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Get the SID Locator (i.e. the first 32 bits) from a SID List.</span>

<span class="sd">    :param sid_list: SID List</span>
<span class="sd">    :type sid_list: list</span>
<span class="sd">    :param locator_bits: Number of bits of the locator part of the SIDs</span>
<span class="sd">    :type locator_bits: int</span>
<span class="sd">    :return: SID Locator</span>
<span class="sd">    :rtype: str</span>
<span class="sd">    :raises SIDLocatorError: SID Locator is wrong for one or more segments</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1"># Locator mask, used to extract the locator from the SIDs</span>
    <span class="c1">#</span>
    <span class="c1"># It is computed with a binary manipulation</span>
    <span class="c1"># We start from the IPv6 address 111...11111, then we put to zero</span>
    <span class="c1"># the bits of the non-locator part</span>
    <span class="c1"># The remaining part is the locator, which is converted to an IPv6Address</span>
    <span class="n">locator_mask</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">IPv6Address</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="s1">&#39;1&#39;</span> <span class="o">*</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">^</span>
                                   <span class="nb">int</span><span class="p">(</span><span class="s1">&#39;1&#39;</span> <span class="o">*</span> <span class="p">(</span><span class="mi">128</span> <span class="o">-</span> <span class="n">locator_bits</span><span class="p">),</span> <span class="mi">2</span><span class="p">)))</span>
    <span class="c1"># Enforce case-sensitivity</span>
    <span class="n">_sid_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">segment</span> <span class="ow">in</span> <span class="n">sid_list</span><span class="p">:</span>
        <span class="n">_sid_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">segment</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
    <span class="n">sid_list</span> <span class="o">=</span> <span class="n">_sid_list</span>
    <span class="c1"># Locator</span>
    <span class="n">locator</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="c1"># Iterate on the SID list</span>
    <span class="k">for</span> <span class="n">segment</span> <span class="ow">in</span> <span class="n">sid_list</span><span class="p">:</span>
        <span class="c1"># Split the segment in...</span>
        <span class="c1"># ...segment locator</span>
        <span class="n">segment_locator</span> <span class="o">=</span> \
            <span class="nb">str</span><span class="p">(</span><span class="n">IPv6Address</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">IPv6Address</span><span class="p">(</span><span class="n">locator_mask</span><span class="p">))</span> <span class="o">&amp;</span>
                            <span class="nb">int</span><span class="p">(</span><span class="n">IPv6Address</span><span class="p">(</span><span class="n">segment</span><span class="p">))))</span>
        <span class="k">if</span> <span class="n">locator</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="c1"># Store the segment</span>
            <span class="n">locator</span> <span class="o">=</span> <span class="n">segment_locator</span>
        <span class="k">elif</span> <span class="n">locator</span> <span class="o">!=</span> <span class="n">segment_locator</span><span class="p">:</span>
            <span class="c1"># All the segments must have the same Locator</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Wrong locator&#39;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">SIDLocatorError</span>
    <span class="c1"># Return the SID Locator</span>
    <span class="k">return</span> <span class="n">locator</span></div>


<div class="viewcode-block" id="sidlist_to_usidlist"><a class="viewcode-back" href="../../controller/api/srv6_usid.html#controller.srv6_usid.sidlist_to_usidlist">[docs]</a><span class="k">def</span> <span class="nf">sidlist_to_usidlist</span><span class="p">(</span><span class="n">sid_list</span><span class="p">,</span> <span class="n">udt_sids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">locator_bits</span><span class="o">=</span><span class="n">DEFAULT_LOCATOR_BITS</span><span class="p">,</span>
                        <span class="n">usid_id_bits</span><span class="o">=</span><span class="n">DEFAULT_USID_ID_BITS</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Convert a SID List into a uSID List.</span>

<span class="sd">    :param sid_list: SID List to be converted</span>
<span class="sd">    :type sid_list: list</span>
<span class="sd">    :param locator_bits: Number of bits of the locator part of the SIDs</span>
<span class="sd">    :type locator_bits: int</span>
<span class="sd">    :param usid_id_bits: Number of bits of the uSID identifiers</span>
<span class="sd">    :type usid_id_bits: int</span>
<span class="sd">    :return: uSID List containing</span>
<span class="sd">    :rtype: list</span>
<span class="sd">    :raises TooManySegmentsError: segments arg contains too many segments</span>
<span class="sd">    :raises SIDLocatorError: SID Locator is wrong for one or more segments</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">udt_sids</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">udt_sids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="c1"># Size of the group of SIDs to be compressed in one uSID</span>
    <span class="c1"># The size depends on the locator bits and uSID ID bits</span>
    <span class="c1"># Last slot should be always leaved free</span>
    <span class="n">sid_group_size</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">((</span><span class="mi">128</span> <span class="o">-</span> <span class="n">locator_bits</span><span class="p">)</span> <span class="o">/</span> <span class="n">usid_id_bits</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="c1"># Get the locator</span>
    <span class="n">locator</span> <span class="o">=</span> <span class="n">get_sid_locator</span><span class="p">(</span><span class="n">sid_list</span><span class="o">=</span><span class="n">sid_list</span><span class="p">,</span> <span class="n">locator_bits</span><span class="o">=</span><span class="n">locator_bits</span><span class="p">)</span>
    <span class="c1"># Micro segments list</span>
    <span class="n">usid_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># Iterate on the SID list</span>
    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">sid_list</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">udt_sids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># Extract the SIDs to be encoded in one uSID</span>
        <span class="n">sids_group</span> <span class="o">=</span> <span class="n">sid_list</span><span class="p">[:</span><span class="n">sid_group_size</span><span class="p">]</span>
        <span class="c1"># uDT list should not be broken into different SIDs</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sid_list</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">udt_sids</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">sid_group_size</span><span class="p">:</span>
            <span class="n">sids_group</span> <span class="o">+=</span> <span class="n">udt_sids</span>
            <span class="n">udt_sids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Segments are encoded in groups of X</span>
        <span class="c1"># Take the first X SIDs, build the uSID and add it to the uSID list</span>
        <span class="n">usid_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">segments_to_micro_segment</span><span class="p">(</span>
                <span class="n">locator</span><span class="o">=</span><span class="n">locator</span><span class="p">,</span>
                <span class="n">segments</span><span class="o">=</span><span class="n">sids_group</span><span class="p">,</span>
                <span class="n">locator_bits</span><span class="o">=</span><span class="n">locator_bits</span><span class="p">,</span>
                <span class="n">usid_id_bits</span><span class="o">=</span><span class="n">usid_id_bits</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="c1"># Advance SID list</span>
        <span class="n">sid_list</span> <span class="o">=</span> <span class="n">sid_list</span><span class="p">[</span><span class="n">sid_group_size</span><span class="p">:]</span>
    <span class="c1"># Return the uSID list</span>
    <span class="k">return</span> <span class="n">usid_list</span></div>


<div class="viewcode-block" id="nodes_to_micro_segments"><a class="viewcode-back" href="../../controller/api/srv6_usid.html#controller.srv6_usid.nodes_to_micro_segments">[docs]</a><span class="k">def</span> <span class="nf">nodes_to_micro_segments</span><span class="p">(</span><span class="n">nodes</span><span class="p">,</span> <span class="n">node_addrs_filename</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Convert a list of nodes into a list of micro segments (uSID List)</span>

<span class="sd">    :param nodes: List of node names</span>
<span class="sd">    :type node: list</span>
<span class="sd">    :param node_to_addr_filename: Name of the YAML file containing the</span>
<span class="sd">                                  mapping of node names to IP addresses</span>
<span class="sd">    :type node_to_addr_filename: str</span>
<span class="sd">    :return: uSID List</span>
<span class="sd">    :rtype: list</span>
<span class="sd">    :raises NodeNotFoundError: Node name not found in the mapping file</span>
<span class="sd">    :raises InvalidConfigurationError: The mapping file is not a valid</span>
<span class="sd">                                       YAML file</span>
<span class="sd">    :raises TooManySegmentsError: segments arg contains more than 6 segments</span>
<span class="sd">    :raises SIDLocatorError: SID Locator is wrong for one or more segments</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c1"># Convert the list of nodes into a list of IP addresses (SID list)</span>
    <span class="c1"># Translation is based on a file containing the mapping</span>
    <span class="c1"># of node names to IP addresses</span>
    <span class="n">nodes_info</span><span class="p">,</span> <span class="n">locator_bits</span><span class="p">,</span> <span class="n">usid_id_bits</span> <span class="o">=</span> <span class="n">read_nodes</span><span class="p">(</span><span class="n">node_addrs_filename</span><span class="p">)</span>
    <span class="n">sid_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">node</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">nodes_info</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NodeNotFoundError</span>
        <span class="n">sid_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nodes_info</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s1">&#39;uN&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">locator_bits</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">locator_bits</span> <span class="o">=</span> <span class="n">DEFAULT_LOCATOR_BITS</span>
    <span class="k">if</span> <span class="n">usid_id_bits</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">usid_id_bits</span> <span class="o">=</span> <span class="n">DEFAULT_USID_ID_BITS</span>
    <span class="c1"># Compress the SID list into a uSID list</span>
    <span class="n">usid_list</span> <span class="o">=</span> <span class="n">sidlist_to_usidlist</span><span class="p">(</span>
        <span class="n">sid_list</span><span class="o">=</span><span class="n">sid_list</span><span class="p">,</span>
        <span class="n">locator_bits</span><span class="o">=</span><span class="n">locator_bits</span><span class="p">,</span>
        <span class="n">usid_id_bits</span><span class="o">=</span><span class="n">usid_id_bits</span>
    <span class="p">)</span>
    <span class="c1"># Return the uSID list</span>
    <span class="k">return</span> <span class="n">usid_list</span></div>


<div class="viewcode-block" id="validate_usid_id"><a class="viewcode-back" href="../../controller/api/srv6_usid.html#controller.srv6_usid.validate_usid_id">[docs]</a><span class="k">def</span> <span class="nf">validate_usid_id</span><span class="p">(</span><span class="n">usid_id</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Validate a uSID identifier. A valid uSID id should be an integer in the</span>
<span class="sd">    range (0, 0xffff).</span>

<span class="sd">    :param usid_id: uSID idenfier to validate.</span>
<span class="sd">    :type usid_id: str</span>
<span class="sd">    :return: True if the uSID identifier is valid.</span>
<span class="sd">    :rtype: bool</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># A valid uSID id should be an integer in the range (0, 0xffff)</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">usid_id</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mh">0x0</span> <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="n">usid_id</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mh">0xffff</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="c1"># The uSID id is invalid</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="usid_id_to_usid"><a class="viewcode-back" href="../../controller/api/srv6_usid.html#controller.srv6_usid.usid_id_to_usid">[docs]</a><span class="k">def</span> <span class="nf">usid_id_to_usid</span><span class="p">(</span><span class="n">usid_id</span><span class="p">,</span> <span class="n">locator</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Convert a uSID identifier into a SID.</span>

<span class="sd">    :param usid_id: uSID idenfier to convert.</span>
<span class="sd">    :type usid_id: str</span>
<span class="sd">    :param locator: Locator part to be used for the SID.</span>
<span class="sd">    :type locator: str</span>
<span class="sd">    :return: Generated SID.</span>
<span class="sd">    :rtype: str</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">IPv6Address</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">IPv6Address</span><span class="p">(</span><span class="n">locator</span><span class="p">))</span> <span class="o">+</span>
                           <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">usid_id</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">80</span><span class="p">)))</span></div>


<div class="viewcode-block" id="encode_endpoint_node"><a class="viewcode-back" href="../../controller/api/srv6_usid.html#controller.srv6_usid.encode_endpoint_node">[docs]</a><span class="k">def</span> <span class="nf">encode_endpoint_node</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">grpc_ip</span><span class="p">,</span> <span class="n">grpc_port</span><span class="p">,</span> <span class="n">fwd_engine</span><span class="p">,</span> <span class="n">locator</span><span class="p">,</span>
                         <span class="n">udt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Get a dict-representation of a node (endpoint of the path), starting from</span>
<span class="sd">    gRPC IP and port, uDT sid, forwarding engine and locator.</span>

<span class="sd">    :param node: Node identifier. This could be a name, a SID (IPv6 address)</span>
<span class="sd">                 or a number (uSID identifier).</span>
<span class="sd">    :type node: str</span>
<span class="sd">    :param grpc_ip: gRPC IP address of the node.</span>
<span class="sd">    :type grpc_ip: str</span>
<span class="sd">    :param grpc_port: Port number of the gRPC server.</span>
<span class="sd">    :type grpc_port: int</span>
<span class="sd">    :param udt: uDT SID of the node, used for the decap operation. If not</span>
<span class="sd">                provided, the uDT SID is not added to the SID list.</span>
<span class="sd">    :type udt: str, optional</span>
<span class="sd">    :param fwd_engine: Forwarding engine to be used (e.g. Linux or VPP).</span>
<span class="sd">    :type fwd_engine: str</span>
<span class="sd">    :param locator: Locator part of the SIDs (e.g. fcbb:bbbb::).</span>
<span class="sd">    :type locator: str</span>
<span class="sd">    :return: Dict representation of the node. The dict has the following</span>
<span class="sd">             fields:</span>
<span class="sd">             - name</span>
<span class="sd">             - grpc_ip</span>
<span class="sd">             - grpc_port</span>
<span class="sd">             - uN</span>
<span class="sd">             - uDT</span>
<span class="sd">             - fwd_engine</span>
<span class="sd">    :rtype: dict</span>
<span class="sd">    :raises InvalidConfigurationError: If the node params are invalid.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1"># Validation checks</span>
    <span class="c1">#</span>
    <span class="c1"># Validate gRPC address</span>
    <span class="k">if</span> <span class="n">grpc_ip</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;grpc_ip is mandatory for node </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">InvalidConfigurationError</span>
    <span class="c1"># Validate gRPC port</span>
    <span class="k">if</span> <span class="n">grpc_port</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;grpc_port is mandatory for node </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">InvalidConfigurationError</span>
    <span class="c1"># Validate forwarding engine</span>
    <span class="k">if</span> <span class="n">fwd_engine</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;grpcfwd_engine_ip is mandatory for node </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">InvalidConfigurationError</span>
    <span class="c1"># Validate locator</span>
    <span class="k">if</span> <span class="n">locator</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;locator is mandatory for node </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">InvalidConfigurationError</span>
    <span class="c1">#</span>
    <span class="c1"># Compute uN SID starting from the provided node identifier</span>
    <span class="c1"># Node identifier can be expressed as SID (an IPv6 address) or a</span>
    <span class="c1"># uSID identifier. If it is a uSID identifier, we need to convert it</span>
    <span class="c1"># to a SID.</span>
    <span class="n">un</span> <span class="o">=</span> <span class="n">node</span>
    <span class="k">if</span> <span class="n">validate_usid_id</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
        <span class="c1"># Node identifier is a integer, we need to convert it to a SID (IPv6</span>
        <span class="c1"># address)</span>
        <span class="n">un</span> <span class="o">=</span> <span class="n">usid_id_to_usid</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">locator</span><span class="p">)</span>
    <span class="c1"># If the node is expressed as IPv6 address or uSID identifier, encode it</span>
    <span class="c1"># Otherwise (if the node is expressed as node name), we return None and we</span>
    <span class="c1"># expect to find the node info in the nodes configuration.</span>
    <span class="k">if</span> <span class="n">utils</span><span class="o">.</span><span class="n">validate_ipv6_address</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="ow">or</span> <span class="n">validate_usid_id</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
        <span class="c1"># Return the dict</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">node</span><span class="p">,</span>
            <span class="s1">&#39;grpc_ip&#39;</span><span class="p">:</span> <span class="n">grpc_ip</span><span class="p">,</span>
            <span class="s1">&#39;grpc_port&#39;</span><span class="p">:</span> <span class="n">grpc_port</span><span class="p">,</span>
            <span class="s1">&#39;uN&#39;</span><span class="p">:</span> <span class="n">un</span><span class="p">,</span>
            <span class="s1">&#39;uDT&#39;</span><span class="p">:</span> <span class="n">udt</span><span class="p">,</span>
            <span class="s1">&#39;fwd_engine&#39;</span><span class="p">:</span> <span class="n">fwd_engine</span>
        <span class="p">}</span>
    <span class="c1"># &#39;Node&#39; is a name. Return None.</span>
    <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="encode_intermediate_node"><a class="viewcode-back" href="../../controller/api/srv6_usid.html#controller.srv6_usid.encode_intermediate_node">[docs]</a><span class="k">def</span> <span class="nf">encode_intermediate_node</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">locator</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Get a dict-representation of a node (intermediate node of the path),</span>
<span class="sd">    starting from gRPC IP and port, uDT sid, forwarding engine and locator.</span>
<span class="sd">    For the intermediate nodes, we don&#39;t need uDT, forwarding engine.</span>
<span class="sd">    gRPC IP and gRPC address.</span>

<span class="sd">    :param node: Node identifier. This could be a name, a SID (IPv6 address)</span>
<span class="sd">                 or a number (uSID identifier).</span>
<span class="sd">    :type node: str</span>
<span class="sd">    :param locator: Locator part of the SIDs (e.g. fcbb:bbbb::).</span>
<span class="sd">    :type locator: str</span>
<span class="sd">    :return: Dict representation of the node. The dict has the following</span>
<span class="sd">             fields:</span>
<span class="sd">             - name</span>
<span class="sd">             - grpc_ip (set to None)</span>
<span class="sd">             - grpc_port (set to None)</span>
<span class="sd">             - uN</span>
<span class="sd">             - uDT (set to None)</span>
<span class="sd">             - fwd_engine (set to None)</span>
<span class="sd">    :rtype: dict</span>
<span class="sd">    :raises InvalidConfigurationError: If the node params are invalid.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1"># Validate params</span>
    <span class="c1">#</span>
    <span class="c1"># Validate locator</span>
    <span class="k">if</span> <span class="n">locator</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;locator is mandatory for node </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">InvalidConfigurationError</span>
    <span class="c1">#</span>
    <span class="c1"># Compute uN SID starting from the provided node identifier</span>
    <span class="c1"># Node identifier can be expressed as SID (an IPv6 address) or a</span>
    <span class="c1"># uSID identifier. If it is a uSID identifier, we need to convert it</span>
    <span class="c1"># to a SID.</span>
    <span class="n">un</span> <span class="o">=</span> <span class="n">node</span>
    <span class="c1"># Node identifier is a integer, we need to convert it to a SID (IPv6</span>
    <span class="c1"># address)</span>
    <span class="k">if</span> <span class="n">validate_usid_id</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
        <span class="n">un</span> <span class="o">=</span> <span class="n">usid_id_to_usid</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">locator</span><span class="p">)</span>
    <span class="c1"># If the node is expressed as IPv6 address or uSID identifier, encode it</span>
    <span class="c1"># Otherwise (if the node is expressed as node name), we return None and we</span>
    <span class="c1"># expect to find the node info in the nodes configuration.</span>
    <span class="k">if</span> <span class="n">utils</span><span class="o">.</span><span class="n">validate_ipv6_address</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="ow">or</span> <span class="n">validate_usid_id</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">node</span><span class="p">,</span>
            <span class="s1">&#39;grpc_ip&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>    <span class="c1"># Useless for intermediate nodes</span>
            <span class="s1">&#39;grpc_port&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>    <span class="c1"># Useless for intermediate nodes</span>
            <span class="s1">&#39;uN&#39;</span><span class="p">:</span> <span class="n">un</span><span class="p">,</span>
            <span class="s1">&#39;uDT&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>    <span class="c1"># Useless for intermediate nodes</span>
            <span class="s1">&#39;fwd_engine&#39;</span><span class="p">:</span> <span class="kc">None</span>    <span class="c1"># Useless for intermediate nodes</span>
        <span class="p">}</span>
    <span class="c1"># &#39;Node&#39; is a name. Return None.</span>
    <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="fill_nodes_info"><a class="viewcode-back" href="../../controller/api/srv6_usid.html#controller.srv6_usid.fill_nodes_info">[docs]</a><span class="k">def</span> <span class="nf">fill_nodes_info</span><span class="p">(</span><span class="n">nodes_info</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">l_grpc_ip</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">l_grpc_port</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">l_fwd_engine</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">r_grpc_ip</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">r_grpc_port</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">r_fwd_engine</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">decap_sid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">locator</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Fill &#39;nodes_info&#39; dict with the nodes containined in the &#39;nodes&#39; list.</span>

<span class="sd">    :param nodes_info: Dict containined the nodes information where to add the</span>
<span class="sd">                       nodes.</span>
<span class="sd">    :type nodes_info: dict</span>
<span class="sd">    :param nodes: List of nodes. Each node can be expressed as SID (IPv6</span>
<span class="sd">                  address), a uSID identifier (integer) or a name.</span>
<span class="sd">    :type nodes: list</span>
<span class="sd">    :param l_grpc_ip: gRPC address of the left node in the path.</span>
<span class="sd">    :type l_grpc_ip: str, optional</span>
<span class="sd">    :param l_grpc_port: Port number of the gRPC server on the left node of</span>
<span class="sd">                        the path.</span>
<span class="sd">    :type l_grpc_port: str, optional</span>
<span class="sd">    :param l_fwd_engine: Forwarding engine to be used on the left node of</span>
<span class="sd">                        the path (e.g. Linux or VPP).</span>
<span class="sd">    :type l_fwd_engine: str, optional</span>
<span class="sd">    :param r_grpc_ip: gRPC address of the right node in the path.</span>
<span class="sd">    :type r_grpc_ip: str, optional</span>
<span class="sd">    :param r_grpc_port: Port number of the gRPC server on the right node of</span>
<span class="sd">                        the path.</span>
<span class="sd">    :type r_grpc_port: str, optional</span>
<span class="sd">    :param r_fwd_engine: Forwarding engine to be used on the right node of</span>
<span class="sd">                        the path (e.g. Linux or VPP).</span>
<span class="sd">    :type r_fwd_engine: str, optional</span>
<span class="sd">    :param decap_sid: Decap SID. This could be a SID (IPv6 address) or a uSID</span>
<span class="sd">                      identifier (an integer).</span>
<span class="sd">    :type decap_sid: str, optional</span>
<span class="sd">    :param locator: Locator part of the SIDs (e.g. fcbb:bbbb::).</span>
<span class="sd">    :type locator: str, optional</span>
<span class="sd">    :raises InvalidConfigurationError: If the node params are invalid.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1"># Convert decap SID to uDT</span>
    <span class="n">udt</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">decap_sid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Locator is required</span>
        <span class="k">if</span> <span class="n">locator</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;locator is mandatory&#39;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">InvalidConfigurationError</span>
        <span class="c1"># Check if decap SID is expressed as a SID (IPv6 address)</span>
        <span class="c1"># or a uSID identifier (an integer)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">utils</span><span class="o">.</span><span class="n">validate_ipv6_address</span><span class="p">(</span><span class="n">decap_sid</span><span class="p">):</span>
            <span class="c1"># Integer, we need to convert it to a SID (IPv6 address)</span>
            <span class="n">udt</span> <span class="o">=</span> <span class="n">usid_id_to_usid</span><span class="p">(</span><span class="n">decap_sid</span><span class="p">,</span> <span class="n">locator</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># IPv6 address</span>
            <span class="n">udt</span> <span class="o">=</span> <span class="n">decap_sid</span>
    <span class="c1"># Encode left node</span>
    <span class="c1">#</span>
    <span class="c1"># A node could be expressed as an integer, an IPv6 address (SID)</span>
    <span class="c1"># or a name</span>
    <span class="n">node</span> <span class="o">=</span> <span class="n">encode_endpoint_node</span><span class="p">(</span>
        <span class="n">node</span><span class="o">=</span><span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">grpc_ip</span><span class="o">=</span><span class="n">l_grpc_ip</span><span class="p">,</span>
        <span class="n">grpc_port</span><span class="o">=</span><span class="n">l_grpc_port</span><span class="p">,</span>
        <span class="n">udt</span><span class="o">=</span><span class="n">udt</span><span class="p">,</span>
        <span class="n">fwd_engine</span><span class="o">=</span><span class="n">l_fwd_engine</span><span class="p">,</span>
        <span class="n">locator</span><span class="o">=</span><span class="n">locator</span>
    <span class="p">)</span>
    <span class="c1"># If we received a node info dict, we add it to the</span>
    <span class="c1"># nodes info dictionary</span>
    <span class="k">if</span> <span class="n">node</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">nodes_info</span><span class="p">[</span><span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">node</span>
    <span class="c1"># Encode right node</span>
    <span class="c1">#</span>
    <span class="c1"># A node could be expressed as an integer, an IPv6 address (SID)</span>
    <span class="c1"># or a name</span>
    <span class="n">node</span> <span class="o">=</span> <span class="n">encode_endpoint_node</span><span class="p">(</span>
        <span class="n">node</span><span class="o">=</span><span class="n">nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
        <span class="n">grpc_ip</span><span class="o">=</span><span class="n">r_grpc_ip</span><span class="p">,</span>
        <span class="n">grpc_port</span><span class="o">=</span><span class="n">r_grpc_port</span><span class="p">,</span>
        <span class="n">udt</span><span class="o">=</span><span class="n">udt</span><span class="p">,</span>
        <span class="n">fwd_engine</span><span class="o">=</span><span class="n">r_fwd_engine</span><span class="p">,</span>
        <span class="n">locator</span><span class="o">=</span><span class="n">locator</span>
    <span class="p">)</span>
    <span class="c1"># If we received a node info dict, we add it to the</span>
    <span class="c1"># nodes info dictionary</span>
    <span class="k">if</span> <span class="n">node</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">nodes_info</span><span class="p">[</span><span class="n">nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">node</span>
    <span class="c1"># Encode intermediate nodes</span>
    <span class="c1"># For the intermediate nodes, we don&#39;t need forwarding engine,</span>
    <span class="c1"># uDT, gRPC IP and port</span>
    <span class="k">for</span> <span class="n">node_name</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
        <span class="c1"># Encode the node</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">encode_intermediate_node</span><span class="p">(</span>
            <span class="n">node</span><span class="o">=</span><span class="n">node_name</span><span class="p">,</span>
            <span class="n">locator</span><span class="o">=</span><span class="n">locator</span>
        <span class="p">)</span>
        <span class="c1"># If we received a node info dict, we add it to the</span>
        <span class="c1"># nodes info dictionary</span>
        <span class="k">if</span> <span class="n">node</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">nodes_info</span><span class="p">[</span><span class="n">node_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">node</span></div>


<div class="viewcode-block" id="handle_srv6_usid_policy"><a class="viewcode-back" href="../../controller/api/srv6_usid.html#controller.srv6_usid.handle_srv6_usid_policy">[docs]</a><span class="k">def</span> <span class="nf">handle_srv6_usid_policy</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="n">nodes_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                            <span class="n">lr_destination</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rl_destination</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                            <span class="n">nodes_lr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                            <span class="n">nodes_rl</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">table</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">metric</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                            <span class="n">persistency</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">l_grpc_ip</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                            <span class="n">l_grpc_port</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">l_fwd_engine</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                            <span class="n">r_grpc_ip</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">r_grpc_port</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                            <span class="n">r_fwd_engine</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">decap_sid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">locator</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Handle a SRv6 Policy using uSIDs</span>

<span class="sd">    :param operation: The operation to be performed on the uSID policy</span>
<span class="sd">                      (i.e. add, get, change, del)</span>
<span class="sd">    :type operation: str</span>
<span class="sd">    :param nodes_dict: Dict containing the nodes configuration.</span>
<span class="sd">    :type nodes_dict: dict</span>
<span class="sd">    :param destination: Destination of the SRv6 route</span>
<span class="sd">    :type destination: str</span>
<span class="sd">    :param nodes: Waypoints of the SRv6 route</span>
<span class="sd">    :type nodes: list</span>
<span class="sd">    :param device: Device of the SRv6 route. If not provided, the device</span>
<span class="sd">                   is selected automatically by the node.</span>
<span class="sd">    :type device: str, optional</span>
<span class="sd">    :param table: Routing table containing the SRv6 route. If not provided,</span>
<span class="sd">                  the main table (i.e. table 254) will be used.</span>
<span class="sd">    :type table: int, optional</span>
<span class="sd">    :param metric: Metric for the SRv6 route. If not provided, the default</span>
<span class="sd">                   metric will be used.</span>
<span class="sd">    :type metric: int, optional</span>
<span class="sd">    :param l_grpc_ip: gRPC IP address of the left node, required if the left</span>
<span class="sd">                      node is expressed numerically in the nodes list.</span>
<span class="sd">    :type l_grpc_ip: str, optional</span>
<span class="sd">    :param l_grpc_port: gRPC port of the left node, required if the left</span>
<span class="sd">                        node is expressed numerically in the nodes list.</span>
<span class="sd">    :type l_grpc_port: str, optional</span>
<span class="sd">    :param l_fwd_engine: forwarding engine of the left node, required if the</span>
<span class="sd">                         left node is expressed numerically in the nodes list.</span>
<span class="sd">    :type l_fwd_engine: str, optional</span>
<span class="sd">    :param r_grpc_ip: gRPC IP address of the right node, required if the right</span>
<span class="sd">                      node is expressed numerically in the nodes list.</span>
<span class="sd">    :type r_grpc_ip: str, optional</span>
<span class="sd">    :param r_grpc_port: gRPC port of the right node, required if the right</span>
<span class="sd">                        node is expressed numerically in the nodes list.</span>
<span class="sd">    :type r_grpc_port: str, optional</span>
<span class="sd">    :param r_fwd_engine: Forwarding engine of the right node, required if the</span>
<span class="sd">                         right node is expressed numerically in the nodes</span>
<span class="sd">                         list.</span>
<span class="sd">    :type r_fwd_engine: str, optional</span>
<span class="sd">    :param decap_sid: uSID used for the decap behavior (End.DT6).</span>
<span class="sd">    :type decap_sid: str, optional</span>
<span class="sd">    :param locator: Locator prefix (e.g. &#39;fcbb:bbbb::&#39;).</span>
<span class="sd">    :type locator: str, optional</span>
<span class="sd">    :return: Status Code of the operation (e.g. 0 for STATUS_SUCCESS)</span>
<span class="sd">    :rtype: int</span>
<span class="sd">    :raises NodeNotFoundError: Node name not found in the mapping file</span>
<span class="sd">    :raises InvalidConfigurationError: The mapping file is not a valid</span>
<span class="sd">                                       YAML file</span>
<span class="sd">    :raises TooManySegmentsError: segments arg contains more than 6 segments</span>
<span class="sd">    :raises SIDLocatorError: SID Locator is wrong for one or more segments</span>
<span class="sd">    :raises InvalidSIDError: SID is wrong for one or more segments</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1"># pylint: disable=too-many-locals, too-many-arguments</span>
    <span class="c1"># pylint: disable=too-many-return-statements, too-many-branches</span>
    <span class="c1"># pylint: disable=too-many-statements</span>
    <span class="c1">#</span>
    <span class="c1"># ArangoDB params</span>
    <span class="n">arango_url</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;ARANGO_URL&#39;</span><span class="p">)</span>
    <span class="n">arango_user</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;ARANGO_USER&#39;</span><span class="p">)</span>
    <span class="n">arango_password</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;ARANGO_PASSWORD&#39;</span><span class="p">)</span>
    <span class="c1">#</span>
    <span class="c1"># Validate arguments</span>
    <span class="k">if</span> <span class="n">lr_destination</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">operation</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;add&#39;</span><span class="p">]:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;&quot;lr_destination&quot; argument is mandatory for </span><span class="si">%s</span><span class="s1"> &#39;</span>
                         <span class="s1">&#39;operation&#39;</span><span class="p">,</span> <span class="n">operation</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">rl_destination</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">operation</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;add&#39;</span><span class="p">]:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;&quot;rl_destination&quot; argument is mandatory for </span><span class="si">%s</span><span class="s1"> &#39;</span>
                         <span class="s1">&#39;operation&#39;</span><span class="p">,</span> <span class="n">operation</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">nodes_lr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">operation</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;add&#39;</span><span class="p">]:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;&quot;nodes_lr&quot; argument is mandatory for </span><span class="si">%s</span><span class="s1"> &#39;</span>
                         <span class="s1">&#39;operation&#39;</span><span class="p">,</span> <span class="n">operation</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">nodes_rl</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">if</span> <span class="n">nodes_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">operation</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;add&#39;</span><span class="p">,</span> <span class="s1">&#39;del&#39;</span><span class="p">]:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;&quot;nodes_filename&quot; argument is mandatory for </span><span class="si">%s</span><span class="s1"> &#39;</span>
                         <span class="s1">&#39;operation&#39;</span><span class="p">,</span> <span class="n">operation</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">operation</span> <span class="o">==</span> <span class="s1">&#39;change&#39;</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Operation not yet implemented: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">operation</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">operation</span> <span class="o">==</span> <span class="s1">&#39;get&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">persistency</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Error in get(): Persistency is disabled&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="c1"># Connect to ArangoDB</span>
        <span class="n">client</span> <span class="o">=</span> <span class="n">arangodb_driver</span><span class="o">.</span><span class="n">connect_arango</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="n">arango_url</span><span class="p">)</span>     <span class="c1"># TODO keep arango connection open</span>
        <span class="c1"># Connect to the db</span>
        <span class="n">database</span> <span class="o">=</span> <span class="n">arangodb_driver</span><span class="o">.</span><span class="n">connect_srv6_usid_db</span><span class="p">(</span>
            <span class="n">client</span><span class="o">=</span><span class="n">client</span><span class="p">,</span>
            <span class="n">username</span><span class="o">=</span><span class="n">arango_user</span><span class="p">,</span>
            <span class="n">password</span><span class="o">=</span><span class="n">arango_password</span>
        <span class="p">)</span>
        <span class="c1"># Get the policy from the db</span>
        <span class="n">policies</span> <span class="o">=</span> <span class="n">arangodb_driver</span><span class="o">.</span><span class="n">find_usid_policy</span><span class="p">(</span>
            <span class="n">database</span><span class="o">=</span><span class="n">database</span><span class="p">,</span>
            <span class="n">key</span><span class="o">=</span><span class="n">_id</span><span class="p">,</span>
            <span class="n">lr_dst</span><span class="o">=</span><span class="n">lr_destination</span><span class="p">,</span>
            <span class="n">rl_dst</span><span class="o">=</span><span class="n">rl_destination</span><span class="p">,</span>
            <span class="n">lr_nodes</span><span class="o">=</span><span class="n">nodes_lr</span><span class="p">,</span>
            <span class="n">rl_nodes</span><span class="o">=</span><span class="n">nodes_rl</span><span class="p">,</span>
            <span class="n">table</span><span class="o">=</span><span class="n">table</span> <span class="k">if</span> <span class="n">table</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">metric</span><span class="o">=</span><span class="n">metric</span> <span class="k">if</span> <span class="n">metric</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="p">)</span>
        <span class="c1"># Print policies</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">*** uSID policies:&#39;</span><span class="p">)</span>
        <span class="n">pprint</span><span class="o">.</span><span class="n">PrettyPrinter</span><span class="p">(</span><span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">pprint</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">policies</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">operation</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;add&#39;</span><span class="p">,</span> <span class="s1">&#39;del&#39;</span><span class="p">]:</span>
        <span class="c1">#</span>
        <span class="c1"># In order to perform this translation, a file containing the</span>
        <span class="c1"># mapping of node names to IPv6 addresses is required</span>
        <span class="c1">#</span>
        <span class="c1"># Read nodes from YAML file</span>
        <span class="n">nodes_info</span> <span class="o">=</span> <span class="n">nodes_dict</span>
        <span class="n">locator_bits</span> <span class="o">=</span> <span class="n">DEFAULT_LOCATOR_BITS</span>  <span class="c1"># TODO configurable locator bits</span>
        <span class="n">usid_id_bits</span> <span class="o">=</span> <span class="n">DEFAULT_USID_ID_BITS</span>  <span class="c1"># TODO configurable uSID id bits</span>
        <span class="c1"># Add nodes list for the left-to-right path to the &#39;nodes_info&#39; dict</span>
        <span class="k">if</span> <span class="n">nodes_lr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fill_nodes_info</span><span class="p">(</span>
                <span class="n">nodes_info</span><span class="o">=</span><span class="n">nodes_info</span><span class="p">,</span>
                <span class="n">nodes</span><span class="o">=</span><span class="n">nodes_lr</span><span class="p">,</span>
                <span class="n">l_grpc_ip</span><span class="o">=</span><span class="n">l_grpc_ip</span><span class="p">,</span>
                <span class="n">l_grpc_port</span><span class="o">=</span><span class="n">l_grpc_port</span><span class="p">,</span>
                <span class="n">l_fwd_engine</span><span class="o">=</span><span class="n">l_fwd_engine</span><span class="p">,</span>
                <span class="n">r_grpc_ip</span><span class="o">=</span><span class="n">r_grpc_ip</span><span class="p">,</span>
                <span class="n">r_grpc_port</span><span class="o">=</span><span class="n">r_grpc_port</span><span class="p">,</span>
                <span class="n">r_fwd_engine</span><span class="o">=</span><span class="n">r_fwd_engine</span><span class="p">,</span>
                <span class="n">decap_sid</span><span class="o">=</span><span class="n">decap_sid</span><span class="p">,</span>
                <span class="n">locator</span><span class="o">=</span><span class="n">locator</span>
            <span class="p">)</span>
        <span class="c1"># Add nodes list for the right-to-left path to the &#39;nodes_info&#39; dict</span>
        <span class="k">if</span> <span class="n">nodes_rl</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fill_nodes_info</span><span class="p">(</span>
                <span class="n">nodes_info</span><span class="o">=</span><span class="n">nodes_info</span><span class="p">,</span>
                <span class="n">nodes</span><span class="o">=</span><span class="n">nodes_rl</span><span class="p">,</span>
                <span class="n">l_grpc_ip</span><span class="o">=</span><span class="n">r_grpc_ip</span><span class="p">,</span>
                <span class="n">l_grpc_port</span><span class="o">=</span><span class="n">r_grpc_port</span><span class="p">,</span>
                <span class="n">l_fwd_engine</span><span class="o">=</span><span class="n">r_fwd_engine</span><span class="p">,</span>
                <span class="n">r_grpc_ip</span><span class="o">=</span><span class="n">l_grpc_ip</span><span class="p">,</span>
                <span class="n">r_grpc_port</span><span class="o">=</span><span class="n">l_grpc_port</span><span class="p">,</span>
                <span class="n">r_fwd_engine</span><span class="o">=</span><span class="n">l_fwd_engine</span><span class="p">,</span>
                <span class="n">decap_sid</span><span class="o">=</span><span class="n">decap_sid</span><span class="p">,</span>
                <span class="n">locator</span><span class="o">=</span><span class="n">locator</span>
            <span class="p">)</span>
        <span class="c1"># Add</span>
        <span class="k">if</span> <span class="n">operation</span> <span class="o">==</span> <span class="s1">&#39;add&#39;</span><span class="p">:</span>
            <span class="n">policies</span> <span class="o">=</span> <span class="p">[{</span>
                <span class="s1">&#39;lr_dst&#39;</span><span class="p">:</span> <span class="n">lr_destination</span><span class="p">,</span>
                <span class="s1">&#39;rl_dst&#39;</span><span class="p">:</span> <span class="n">rl_destination</span><span class="p">,</span>
                <span class="s1">&#39;lr_nodes&#39;</span><span class="p">:</span> <span class="n">nodes_lr</span><span class="p">,</span>
                <span class="s1">&#39;rl_nodes&#39;</span><span class="p">:</span> <span class="n">nodes_rl</span>
            <span class="p">}]</span>
        <span class="k">if</span> <span class="n">operation</span> <span class="o">==</span> <span class="s1">&#39;del&#39;</span><span class="p">:</span>
            <span class="c1">#</span>
            <span class="c1"># Connect to ArangoDB</span>
            <span class="n">client</span> <span class="o">=</span> <span class="n">arangodb_driver</span><span class="o">.</span><span class="n">connect_arango</span><span class="p">(</span>
                <span class="n">url</span><span class="o">=</span><span class="n">arango_url</span><span class="p">)</span>     <span class="c1"># TODO keep arango connection open</span>
            <span class="c1"># Connect to the db</span>
            <span class="n">database</span> <span class="o">=</span> <span class="n">arangodb_driver</span><span class="o">.</span><span class="n">connect_srv6_usid_db</span><span class="p">(</span>
                <span class="n">client</span><span class="o">=</span><span class="n">client</span><span class="p">,</span>
                <span class="n">username</span><span class="o">=</span><span class="n">arango_user</span><span class="p">,</span>
                <span class="n">password</span><span class="o">=</span><span class="n">arango_password</span>
            <span class="p">)</span>
            <span class="c1"># Get the policy from the db</span>
            <span class="n">policies</span> <span class="o">=</span> <span class="n">arangodb_driver</span><span class="o">.</span><span class="n">find_usid_policy</span><span class="p">(</span>
                <span class="n">database</span><span class="o">=</span><span class="n">database</span><span class="p">,</span>
                <span class="n">key</span><span class="o">=</span><span class="n">_id</span><span class="p">,</span>
                <span class="n">lr_dst</span><span class="o">=</span><span class="n">lr_destination</span><span class="p">,</span>
                <span class="n">rl_dst</span><span class="o">=</span><span class="n">rl_destination</span><span class="p">,</span>
                <span class="n">lr_nodes</span><span class="o">=</span><span class="n">nodes_lr</span><span class="p">,</span>
                <span class="n">rl_nodes</span><span class="o">=</span><span class="n">nodes_rl</span><span class="p">,</span>
                <span class="n">table</span><span class="o">=</span><span class="n">table</span> <span class="k">if</span> <span class="n">table</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">metric</span><span class="o">=</span><span class="n">metric</span> <span class="k">if</span> <span class="n">metric</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="p">)</span>

            <span class="n">policies</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">policies</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">policy</span> <span class="ow">in</span> <span class="n">policies</span><span class="p">:</span>
                <span class="c1"># Add nodes list for the left-to-right path to the</span>
                <span class="c1"># &#39;nodes_info&#39; dict</span>
                <span class="k">if</span> <span class="n">policy</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;lr_nodes&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">fill_nodes_info</span><span class="p">(</span>
                        <span class="n">nodes_info</span><span class="o">=</span><span class="n">nodes_info</span><span class="p">,</span>
                        <span class="n">nodes</span><span class="o">=</span><span class="n">policy</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;lr_nodes&#39;</span><span class="p">),</span>
                        <span class="n">l_grpc_ip</span><span class="o">=</span><span class="n">policy</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;l_grpc_ip&#39;</span><span class="p">),</span>
                        <span class="n">l_grpc_port</span><span class="o">=</span><span class="n">policy</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;l_grpc_port&#39;</span><span class="p">),</span>
                        <span class="n">l_fwd_engine</span><span class="o">=</span><span class="n">policy</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;l_fwd_engine&#39;</span><span class="p">),</span>
                        <span class="n">r_grpc_ip</span><span class="o">=</span><span class="n">policy</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;r_grpc_ip&#39;</span><span class="p">),</span>
                        <span class="n">r_grpc_port</span><span class="o">=</span><span class="n">policy</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;r_grpc_port&#39;</span><span class="p">),</span>
                        <span class="n">r_fwd_engine</span><span class="o">=</span><span class="n">policy</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;r_fwd_engine&#39;</span><span class="p">),</span>
                        <span class="n">decap_sid</span><span class="o">=</span><span class="n">policy</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;decap_sid&#39;</span><span class="p">),</span>
                        <span class="n">locator</span><span class="o">=</span><span class="n">policy</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;locator&#39;</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="c1"># Add nodes list for the right-to-left path to the</span>
                <span class="c1"># &#39;nodes_info&#39; dict</span>
                <span class="k">if</span> <span class="n">policy</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rl_nodes&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">fill_nodes_info</span><span class="p">(</span>
                        <span class="n">nodes_info</span><span class="o">=</span><span class="n">nodes_info</span><span class="p">,</span>
                        <span class="n">nodes</span><span class="o">=</span><span class="n">policy</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rl_nodes&#39;</span><span class="p">),</span>
                        <span class="n">l_grpc_ip</span><span class="o">=</span><span class="n">policy</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;r_grpc_ip&#39;</span><span class="p">),</span>
                        <span class="n">l_grpc_port</span><span class="o">=</span><span class="n">policy</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;r_grpc_port&#39;</span><span class="p">),</span>
                        <span class="n">l_fwd_engine</span><span class="o">=</span><span class="n">policy</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;r_fwd_engine&#39;</span><span class="p">),</span>
                        <span class="n">r_grpc_ip</span><span class="o">=</span><span class="n">policy</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;l_grpc_ip&#39;</span><span class="p">),</span>
                        <span class="n">r_grpc_port</span><span class="o">=</span><span class="n">policy</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;l_grpc_port&#39;</span><span class="p">),</span>
                        <span class="n">r_fwd_engine</span><span class="o">=</span><span class="n">policy</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;l_fwd_engine&#39;</span><span class="p">),</span>
                        <span class="n">decap_sid</span><span class="o">=</span><span class="n">policy</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;decap_sid&#39;</span><span class="p">),</span>
                        <span class="n">locator</span><span class="o">=</span><span class="n">policy</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;locator&#39;</span><span class="p">)</span>
                    <span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">policies</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Policy not found&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="c1"># Iterate on the policies</span>
        <span class="k">for</span> <span class="n">policy</span> <span class="ow">in</span> <span class="n">policies</span><span class="p">:</span>
            <span class="n">lr_destination</span> <span class="o">=</span> <span class="n">policy</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;lr_dst&#39;</span><span class="p">)</span>
            <span class="n">rl_destination</span> <span class="o">=</span> <span class="n">policy</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rl_dst&#39;</span><span class="p">)</span>
            <span class="n">nodes_lr</span> <span class="o">=</span> <span class="n">policy</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;lr_nodes&#39;</span><span class="p">)</span>
            <span class="n">nodes_rl</span> <span class="o">=</span> <span class="n">policy</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rl_nodes&#39;</span><span class="p">)</span>
            <span class="n">_id</span> <span class="o">=</span> <span class="n">policy</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_key&#39;</span><span class="p">)</span>
            <span class="c1">#</span>
            <span class="c1"># If right to left nodes list is not provided, we use the reverse</span>
            <span class="c1"># left to right SID list (symmetric path)</span>
            <span class="k">if</span> <span class="n">nodes_rl</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">nodes_rl</span> <span class="o">=</span> <span class="n">nodes_lr</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="c1"># The two SID lists must have the same endpoints</span>
            <span class="k">if</span> <span class="n">nodes_lr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">nodes_rl</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">or</span> <span class="n">nodes_rl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">nodes_lr</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Bad tunnel endpoints&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="c1"># Create the SRv6 Policy</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># # Prefix length for local segment</span>
                <span class="c1"># prefix_len = locator_bits + usid_id_bits</span>
                <span class="c1"># Ingress node</span>
                <span class="n">ingress_node</span> <span class="o">=</span> <span class="n">nodes_info</span><span class="p">[</span><span class="n">nodes_lr</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                <span class="c1"># Intermediate nodes</span>
                <span class="n">intermediate_nodes_lr</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes_lr</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">intermediate_nodes_lr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nodes_info</span><span class="p">[</span><span class="n">node</span><span class="p">])</span>
                <span class="n">intermediate_nodes_rl</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes_rl</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">intermediate_nodes_rl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nodes_info</span><span class="p">[</span><span class="n">node</span><span class="p">])</span>
                <span class="c1"># Egress node</span>
                <span class="n">egress_node</span> <span class="o">=</span> <span class="n">nodes_info</span><span class="p">[</span><span class="n">nodes_lr</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
                <span class="c1"># Extract the segments</span>
                <span class="n">segments_lr</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes_lr</span><span class="p">:</span>
                    <span class="n">segments_lr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nodes_info</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s1">&#39;uN&#39;</span><span class="p">])</span>
                <span class="n">segments_rl</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes_rl</span><span class="p">:</span>
                    <span class="n">segments_rl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nodes_info</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s1">&#39;uN&#39;</span><span class="p">])</span>

                <span class="c1"># Ingress node</span>
                <span class="k">with</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_grpc_session</span><span class="p">(</span><span class="n">ingress_node</span><span class="p">[</span><span class="s1">&#39;grpc_ip&#39;</span><span class="p">],</span>
                                            <span class="n">ingress_node</span><span class="p">[</span><span class="s1">&#39;grpc_port&#39;</span><span class="p">]</span>
                                            <span class="p">)</span> <span class="k">as</span> <span class="n">channel</span><span class="p">:</span>
                    <span class="c1"># Currently ony Linux and VPP are suppoted for the encap</span>
                    <span class="k">if</span> <span class="n">ingress_node</span><span class="p">[</span><span class="s1">&#39;fwd_engine&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;linux&#39;</span><span class="p">,</span> <span class="s1">&#39;vpp&#39;</span><span class="p">]:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                            <span class="s1">&#39;Encap operation is not supported for &#39;</span>
                            <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> with fwd engine </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
                            <span class="n">ingress_node</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
                            <span class="n">ingress_node</span><span class="p">[</span><span class="s1">&#39;fwd_engine&#39;</span><span class="p">])</span>
                        <span class="k">return</span> <span class="n">commons_pb2</span><span class="o">.</span><span class="n">STATUS_INTERNAL_ERROR</span>
                    <span class="c1"># VPP requires a BSID address</span>
                    <span class="n">bsid_addr</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                    <span class="k">if</span> <span class="n">ingress_node</span><span class="p">[</span><span class="s1">&#39;fwd_engine&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;VPP&#39;</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">lr_destination</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">char</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">):</span>
                                <span class="n">bsid_addr</span> <span class="o">+=</span> <span class="n">char</span>
                        <span class="n">add_colon</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bsid_addr</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">28</span><span class="p">:</span>
                            <span class="n">add_colon</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">bsid_addr</span> <span class="o">=</span> <span class="p">[(</span><span class="n">bsid_addr</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="mi">4</span><span class="p">])</span>
                                     <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">bsid_addr</span><span class="p">),</span> <span class="mi">4</span><span class="p">)]</span>
                        <span class="n">bsid_addr</span> <span class="o">=</span> <span class="s1">&#39;:&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">bsid_addr</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">add_colon</span><span class="p">:</span>
                            <span class="n">bsid_addr</span> <span class="o">+=</span> <span class="s1">&#39;::&#39;</span>

                    <span class="n">udt_sids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
                    <span class="c1"># Locator mask</span>
                    <span class="n">locator_mask</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">IPv6Address</span><span class="p">(</span>
                        <span class="nb">int</span><span class="p">(</span><span class="s1">&#39;1&#39;</span> <span class="o">*</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">^</span>
                        <span class="nb">int</span><span class="p">(</span><span class="s1">&#39;1&#39;</span> <span class="o">*</span> <span class="p">(</span><span class="mi">128</span> <span class="o">-</span> <span class="n">locator_bits</span><span class="p">),</span> <span class="mi">2</span><span class="p">)))</span>
                    <span class="c1"># uDT mask</span>
                    <span class="n">udt_mask_1</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span>
                        <span class="n">IPv6Address</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="s1">&#39;1&#39;</span> <span class="o">*</span> <span class="n">usid_id_bits</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
                                    <span class="p">(</span><span class="mi">128</span> <span class="o">-</span> <span class="n">locator_bits</span> <span class="o">-</span> <span class="n">usid_id_bits</span><span class="p">)))</span>
                    <span class="n">udt_mask_2</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span>
                        <span class="n">IPv6Address</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="s1">&#39;1&#39;</span> <span class="o">*</span> <span class="n">usid_id_bits</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
                                    <span class="p">(</span><span class="mi">128</span> <span class="o">-</span> <span class="n">locator_bits</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">usid_id_bits</span><span class="p">)))</span>
                    <span class="c1"># Build uDT sid list</span>
                    <span class="n">locator_int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">IPv6Address</span><span class="p">(</span><span class="n">egress_node</span><span class="p">[</span><span class="s1">&#39;uDT&#39;</span><span class="p">]))</span> <span class="o">&amp;</span> \
                        <span class="nb">int</span><span class="p">(</span><span class="n">IPv6Address</span><span class="p">(</span><span class="n">locator_mask</span><span class="p">))</span>
                    <span class="n">udt_mask_1_int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">IPv6Address</span><span class="p">(</span><span class="n">egress_node</span><span class="p">[</span><span class="s1">&#39;uDT&#39;</span><span class="p">]))</span> <span class="o">&amp;</span> \
                        <span class="nb">int</span><span class="p">(</span><span class="n">IPv6Address</span><span class="p">(</span><span class="n">udt_mask_1</span><span class="p">))</span>
                    <span class="n">udt_mask_2_int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">IPv6Address</span><span class="p">(</span><span class="n">egress_node</span><span class="p">[</span><span class="s1">&#39;uDT&#39;</span><span class="p">]))</span> <span class="o">&amp;</span> \
                        <span class="nb">int</span><span class="p">(</span><span class="n">IPv6Address</span><span class="p">(</span><span class="n">udt_mask_2</span><span class="p">))</span>
                    <span class="n">udt_sids</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">IPv6Address</span><span class="p">(</span><span class="n">locator_int</span> <span class="o">+</span>
                                                 <span class="n">udt_mask_1_int</span><span class="p">))]</span>
                    <span class="n">udt_sids</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">IPv6Address</span><span class="p">(</span><span class="n">locator_int</span> <span class="o">+</span>
                                                 <span class="p">(</span><span class="n">udt_mask_2_int</span> <span class="o">&lt;&lt;</span>
                                                  <span class="n">usid_id_bits</span><span class="p">)))]</span>
                    <span class="c1"># We need to convert the SID list into a uSID list</span>
                    <span class="c1">#  before creating the SRv6 policy</span>
                    <span class="n">usid_list</span> <span class="o">=</span> <span class="n">sidlist_to_usidlist</span><span class="p">(</span>
                        <span class="n">sid_list</span><span class="o">=</span><span class="n">segments_lr</span><span class="p">[</span><span class="mi">1</span><span class="p">:][:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                        <span class="n">udt_sids</span><span class="o">=</span><span class="p">[</span><span class="n">segments_lr</span><span class="p">[</span><span class="mi">1</span><span class="p">:][</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">+</span> <span class="n">udt_sids</span><span class="p">,</span>
                        <span class="n">locator_bits</span><span class="o">=</span><span class="n">locator_bits</span><span class="p">,</span>
                        <span class="n">usid_id_bits</span><span class="o">=</span><span class="n">usid_id_bits</span>
                    <span class="p">)</span>
                    <span class="c1"># Handle a SRv6 path</span>
                    <span class="n">response</span> <span class="o">=</span> <span class="n">srv6_utils</span><span class="o">.</span><span class="n">handle_srv6_path</span><span class="p">(</span>
                        <span class="n">operation</span><span class="o">=</span><span class="n">operation</span><span class="p">,</span>
                        <span class="n">channel</span><span class="o">=</span><span class="n">channel</span><span class="p">,</span>
                        <span class="n">destination</span><span class="o">=</span><span class="n">lr_destination</span><span class="p">,</span>
                        <span class="n">segments</span><span class="o">=</span><span class="n">usid_list</span><span class="p">,</span>
                        <span class="n">encapmode</span><span class="o">=</span><span class="s1">&#39;encap.red&#39;</span><span class="p">,</span>
                        <span class="n">table</span><span class="o">=</span><span class="n">table</span><span class="p">,</span>
                        <span class="n">metric</span><span class="o">=</span><span class="n">metric</span><span class="p">,</span>
                        <span class="n">bsid_addr</span><span class="o">=</span><span class="n">bsid_addr</span><span class="p">,</span>
                        <span class="n">fwd_engine</span><span class="o">=</span><span class="n">ingress_node</span><span class="p">[</span><span class="s1">&#39;fwd_engine&#39;</span><span class="p">],</span>
                        <span class="n">update_db</span><span class="o">=</span><span class="kc">False</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">response</span> <span class="o">!=</span> <span class="n">commons_pb2</span><span class="o">.</span><span class="n">STATUS_SUCCESS</span><span class="p">:</span>
                        <span class="c1"># Error</span>
                        <span class="k">return</span> <span class="n">response</span>
                    <span class="c1"># # Create the uN behavior</span>
                    <span class="c1"># response = handle_srv6_behavior(</span>
                    <span class="c1">#     operation=operation,</span>
                    <span class="c1">#     channel=channel,</span>
                    <span class="c1">#     segment=&#39;%s/%s&#39; % (ingress_node[&#39;uN&#39;], prefix_len),</span>
                    <span class="c1">#     action=&#39;uN&#39;,</span>
                    <span class="c1">#     fwd_engine=ingress_node[&#39;fwd_engine&#39;]</span>
                    <span class="c1"># )</span>
                    <span class="c1"># if response != commons_pb2.STATUS_SUCCESS:</span>
                    <span class="c1">#     # Error</span>
                    <span class="c1">#     return response</span>
                    <span class="c1"># # Create the End behavior</span>
                    <span class="c1"># response = handle_srv6_behavior(</span>
                    <span class="c1">#     operation=operation,</span>
                    <span class="c1">#     channel=channel,</span>
                    <span class="c1">#     segment=&#39;%s/%s&#39; % (ingress_node[&#39;uN&#39;], 64),</span>
                    <span class="c1">#     action=&#39;End&#39;,</span>
                    <span class="c1">#     fwd_engine=ingress_node[&#39;fwd_engine&#39;]</span>
                    <span class="c1"># )</span>
                    <span class="c1"># if response != commons_pb2.STATUS_SUCCESS:</span>
                    <span class="c1">#     # Error</span>
                    <span class="c1">#     return response</span>
                    <span class="c1"># # Create the decap behavior</span>
                    <span class="c1"># response = handle_srv6_behavior(</span>
                    <span class="c1">#     operation=operation,</span>
                    <span class="c1">#     channel=channel,</span>
                    <span class="c1">#     segment=&#39;%s/%s&#39; % (ingress_node[&#39;uDT&#39;], 64),</span>
                    <span class="c1">#     action=&#39;End.DT6&#39;,</span>
                    <span class="c1">#     lookup_table=254,</span>
                    <span class="c1">#     fwd_engine=ingress_node[&#39;fwd_engine&#39;]</span>
                    <span class="c1"># )</span>
                    <span class="c1"># if response != commons_pb2.STATUS_SUCCESS:</span>
                    <span class="c1">#     # Error</span>
                    <span class="c1">#     return response</span>
                <span class="c1"># # Intermediate nodes</span>
                <span class="c1"># for node in intermediate_nodes:</span>
                <span class="c1">#     with utils.get_grpc_session(node[&#39;grpc_ip&#39;],</span>
                <span class="c1">#                                 node[&#39;grpc_port&#39;]</span>
                <span class="c1">#                                 ) as channel:</span>
                <span class="c1">#         # Create the uN behavior</span>
                <span class="c1">#         response = handle_srv6_behavior(</span>
                <span class="c1">#             operation=operation,</span>
                <span class="c1">#             channel=channel,</span>
                <span class="c1">#             segment=&#39;%s/%s&#39; % (node[&#39;uN&#39;], prefix_len),</span>
                <span class="c1">#             action=&#39;uN&#39;,</span>
                <span class="c1">#             fwd_engine=node[&#39;fwd_engine&#39;]</span>
                <span class="c1">#         )</span>
                <span class="c1">#         if response != commons_pb2.STATUS_SUCCESS:</span>
                <span class="c1">#             # Error</span>
                <span class="c1">#             return response</span>
                <span class="c1"># Egress node</span>
                <span class="k">with</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_grpc_session</span><span class="p">(</span><span class="n">egress_node</span><span class="p">[</span><span class="s1">&#39;grpc_ip&#39;</span><span class="p">],</span>
                                            <span class="n">egress_node</span><span class="p">[</span><span class="s1">&#39;grpc_port&#39;</span><span class="p">]</span>
                                            <span class="p">)</span> <span class="k">as</span> <span class="n">channel</span><span class="p">:</span>
                    <span class="c1"># Currently ony Linux and VPP are suppoted for the encap</span>
                    <span class="k">if</span> <span class="n">egress_node</span><span class="p">[</span><span class="s1">&#39;fwd_engine&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;linux&#39;</span><span class="p">,</span> <span class="s1">&#39;vpp&#39;</span><span class="p">]:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                            <span class="s1">&#39;Encap operation is not supported for &#39;</span>
                            <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> with fwd engine </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
                            <span class="n">egress_node</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="n">egress_node</span><span class="p">[</span><span class="s1">&#39;fwd_engine&#39;</span><span class="p">])</span>
                        <span class="k">return</span> <span class="n">commons_pb2</span><span class="o">.</span><span class="n">STATUS_INTERNAL_ERROR</span>
                    <span class="c1"># VPP requires a BSID address</span>
                    <span class="n">bsid_addr</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                    <span class="k">if</span> <span class="n">egress_node</span><span class="p">[</span><span class="s1">&#39;fwd_engine&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;VPP&#39;</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">lr_destination</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">char</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">):</span>
                                <span class="n">bsid_addr</span> <span class="o">+=</span> <span class="n">char</span>
                        <span class="n">add_colon</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bsid_addr</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">28</span><span class="p">:</span>
                            <span class="n">add_colon</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">bsid_addr</span> <span class="o">=</span> <span class="p">[(</span><span class="n">bsid_addr</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="mi">4</span><span class="p">])</span>
                                     <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">bsid_addr</span><span class="p">),</span> <span class="mi">4</span><span class="p">)]</span>
                        <span class="n">bsid_addr</span> <span class="o">=</span> <span class="s1">&#39;:&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">bsid_addr</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">add_colon</span><span class="p">:</span>
                            <span class="n">bsid_addr</span> <span class="o">+=</span> <span class="s1">&#39;::&#39;</span>
                    <span class="c1"># # Create the uN behavior</span>
                    <span class="c1"># response = handle_srv6_behavior(</span>
                    <span class="c1">#     operation=operation,</span>
                    <span class="c1">#     channel=channel,</span>
                    <span class="c1">#     segment=&#39;%s/%s&#39; % (egress_node[&#39;uN&#39;], prefix_len),</span>
                    <span class="c1">#     action=&#39;uN&#39;,</span>
                    <span class="c1">#     fwd_engine=egress_node[&#39;fwd_engine&#39;]</span>
                    <span class="c1"># )</span>
                    <span class="c1"># if response != commons_pb2.STATUS_SUCCESS:</span>
                    <span class="c1">#     # Error</span>
                    <span class="c1">#     return response</span>
                    <span class="c1"># # Create the End behavior</span>
                    <span class="c1"># response = handle_srv6_behavior(</span>
                    <span class="c1">#     operation=operation,</span>
                    <span class="c1">#     channel=channel,</span>
                    <span class="c1">#     segment=&#39;%s/%s&#39; % (egress_node[&#39;uN&#39;], 64),</span>
                    <span class="c1">#     action=&#39;End&#39;,</span>
                    <span class="c1">#     fwd_engine=egress_node[&#39;fwd_engine&#39;]</span>
                    <span class="c1"># )</span>
                    <span class="c1"># if response != commons_pb2.STATUS_SUCCESS:</span>
                    <span class="c1">#     # Error</span>
                    <span class="c1">#     return response</span>
                    <span class="c1"># # Create the decap behavior</span>
                    <span class="c1"># response = handle_srv6_behavior(</span>
                    <span class="c1">#     operation=operation,</span>
                    <span class="c1">#     channel=channel,</span>
                    <span class="c1">#     segment=&#39;%s/%s&#39; % (egress_node[&#39;uDT&#39;], 64),</span>
                    <span class="c1">#     action=&#39;End.DT6&#39;,</span>
                    <span class="c1">#     lookup_table=254,</span>
                    <span class="c1">#     fwd_engine=egress_node[&#39;fwd_engine&#39;]</span>
                    <span class="c1"># )</span>
                    <span class="c1"># if response != commons_pb2.STATUS_SUCCESS:</span>
                    <span class="c1">#     # Error</span>
                    <span class="c1">#     return response</span>
                    <span class="n">udt_sids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
                    <span class="c1"># Locator mask</span>
                    <span class="n">locator_mask</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">IPv6Address</span><span class="p">(</span>
                        <span class="nb">int</span><span class="p">(</span><span class="s1">&#39;1&#39;</span> <span class="o">*</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">^</span>
                        <span class="nb">int</span><span class="p">(</span><span class="s1">&#39;1&#39;</span> <span class="o">*</span> <span class="p">(</span><span class="mi">128</span> <span class="o">-</span> <span class="n">locator_bits</span><span class="p">),</span> <span class="mi">2</span><span class="p">)))</span>
                    <span class="c1"># uDT mask</span>
                    <span class="n">udt_mask_1</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">IPv6Address</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="s1">&#39;1&#39;</span> <span class="o">*</span> <span class="n">usid_id_bits</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
                                                 <span class="p">(</span><span class="mi">128</span> <span class="o">-</span> <span class="n">locator_bits</span> <span class="o">-</span>
                                                  <span class="n">usid_id_bits</span><span class="p">)))</span>
                    <span class="n">udt_mask_2</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">IPv6Address</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="s1">&#39;1&#39;</span> <span class="o">*</span> <span class="n">usid_id_bits</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
                                                 <span class="p">(</span><span class="mi">128</span> <span class="o">-</span> <span class="n">locator_bits</span> <span class="o">-</span>
                                                  <span class="mi">2</span> <span class="o">*</span> <span class="n">usid_id_bits</span><span class="p">)))</span>
                    <span class="c1"># Build uDT sid list</span>
                    <span class="n">locator_int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
                        <span class="n">IPv6Address</span><span class="p">(</span>
                            <span class="n">ingress_node</span><span class="p">[</span><span class="s1">&#39;uDT&#39;</span><span class="p">]))</span> <span class="o">&amp;</span> <span class="nb">int</span><span class="p">(</span>
                                <span class="n">IPv6Address</span><span class="p">(</span><span class="n">locator_mask</span><span class="p">))</span>
                    <span class="n">udt_mask_1_int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
                        <span class="n">IPv6Address</span><span class="p">(</span>
                            <span class="n">ingress_node</span><span class="p">[</span><span class="s1">&#39;uDT&#39;</span><span class="p">]))</span> <span class="o">&amp;</span> <span class="nb">int</span><span class="p">(</span>
                                <span class="n">IPv6Address</span><span class="p">(</span><span class="n">udt_mask_1</span><span class="p">))</span>
                    <span class="n">udt_mask_2_int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
                        <span class="n">IPv6Address</span><span class="p">(</span>
                            <span class="n">ingress_node</span><span class="p">[</span><span class="s1">&#39;uDT&#39;</span><span class="p">]))</span> <span class="o">&amp;</span> <span class="nb">int</span><span class="p">(</span>
                                <span class="n">IPv6Address</span><span class="p">(</span><span class="n">udt_mask_2</span><span class="p">))</span>
                    <span class="n">udt_sids</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">IPv6Address</span><span class="p">(</span><span class="n">locator_int</span> <span class="o">+</span>
                                                 <span class="n">udt_mask_1_int</span><span class="p">))]</span>
                    <span class="n">udt_sids</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">IPv6Address</span><span class="p">(</span><span class="n">locator_int</span> <span class="o">+</span>
                                                 <span class="p">(</span><span class="n">udt_mask_2_int</span> <span class="o">&lt;&lt;</span>
                                                  <span class="n">usid_id_bits</span><span class="p">)))]</span>
                    <span class="c1"># We need to convert the SID list into a uSID list</span>
                    <span class="c1">#  before creating the SRv6 policy</span>
                    <span class="n">usid_list</span> <span class="o">=</span> <span class="n">sidlist_to_usidlist</span><span class="p">(</span>
                        <span class="n">sid_list</span><span class="o">=</span><span class="n">segments_rl</span><span class="p">[</span><span class="mi">1</span><span class="p">:][:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                        <span class="n">udt_sids</span><span class="o">=</span><span class="p">[</span><span class="n">segments_rl</span><span class="p">[</span><span class="mi">1</span><span class="p">:][</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">+</span> <span class="n">udt_sids</span><span class="p">,</span>
                        <span class="n">locator_bits</span><span class="o">=</span><span class="n">locator_bits</span><span class="p">,</span>
                        <span class="n">usid_id_bits</span><span class="o">=</span><span class="n">usid_id_bits</span>
                    <span class="p">)</span>
                    <span class="c1"># Handle a SRv6 path</span>
                    <span class="n">response</span> <span class="o">=</span> <span class="n">srv6_utils</span><span class="o">.</span><span class="n">handle_srv6_path</span><span class="p">(</span>
                        <span class="n">operation</span><span class="o">=</span><span class="n">operation</span><span class="p">,</span>
                        <span class="n">channel</span><span class="o">=</span><span class="n">channel</span><span class="p">,</span>
                        <span class="n">destination</span><span class="o">=</span><span class="n">rl_destination</span><span class="p">,</span>
                        <span class="n">segments</span><span class="o">=</span><span class="n">usid_list</span><span class="p">,</span>
                        <span class="n">encapmode</span><span class="o">=</span><span class="s1">&#39;encap.red&#39;</span><span class="p">,</span>
                        <span class="n">table</span><span class="o">=</span><span class="n">table</span><span class="p">,</span>
                        <span class="n">metric</span><span class="o">=</span><span class="n">metric</span><span class="p">,</span>
                        <span class="n">bsid_addr</span><span class="o">=</span><span class="n">bsid_addr</span><span class="p">,</span>
                        <span class="n">fwd_engine</span><span class="o">=</span><span class="n">egress_node</span><span class="p">[</span><span class="s1">&#39;fwd_engine&#39;</span><span class="p">],</span>
                        <span class="n">update_db</span><span class="o">=</span><span class="kc">False</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">response</span> <span class="o">!=</span> <span class="n">commons_pb2</span><span class="o">.</span><span class="n">STATUS_SUCCESS</span><span class="p">:</span>
                        <span class="c1"># Error</span>
                        <span class="k">return</span> <span class="n">response</span>
                <span class="c1"># Persist uSID policy to database</span>
                <span class="k">if</span> <span class="n">persistency</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">operation</span> <span class="o">==</span> <span class="s1">&#39;add&#39;</span><span class="p">:</span>
                        <span class="c1"># Connect to ArangoDB</span>
                        <span class="n">client</span> <span class="o">=</span> <span class="n">arangodb_driver</span><span class="o">.</span><span class="n">connect_arango</span><span class="p">(</span>
                            <span class="n">url</span><span class="o">=</span><span class="n">arango_url</span><span class="p">)</span>  <span class="c1"># TODO keep arango connection open</span>
                        <span class="c1"># Connect to the db</span>
                        <span class="n">database</span> <span class="o">=</span> <span class="n">arangodb_driver</span><span class="o">.</span><span class="n">connect_srv6_usid_db</span><span class="p">(</span>
                            <span class="n">client</span><span class="o">=</span><span class="n">client</span><span class="p">,</span>
                            <span class="n">username</span><span class="o">=</span><span class="n">arango_user</span><span class="p">,</span>
                            <span class="n">password</span><span class="o">=</span><span class="n">arango_password</span>
                        <span class="p">)</span>
                        <span class="c1"># Save the policy to the db</span>
                        <span class="n">arangodb_driver</span><span class="o">.</span><span class="n">insert_usid_policy</span><span class="p">(</span>
                            <span class="n">database</span><span class="o">=</span><span class="n">database</span><span class="p">,</span>
                            <span class="n">lr_dst</span><span class="o">=</span><span class="n">lr_destination</span><span class="p">,</span>
                            <span class="n">rl_dst</span><span class="o">=</span><span class="n">rl_destination</span><span class="p">,</span>
                            <span class="n">lr_nodes</span><span class="o">=</span><span class="n">nodes_lr</span><span class="p">,</span>
                            <span class="n">rl_nodes</span><span class="o">=</span><span class="n">nodes_rl</span><span class="p">,</span>
                            <span class="n">table</span><span class="o">=</span><span class="n">table</span> <span class="k">if</span> <span class="n">table</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="n">metric</span><span class="o">=</span><span class="n">metric</span> <span class="k">if</span> <span class="n">metric</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="n">l_grpc_ip</span><span class="o">=</span><span class="n">l_grpc_ip</span><span class="p">,</span>
                            <span class="n">l_grpc_port</span><span class="o">=</span><span class="n">l_grpc_port</span><span class="p">,</span>
                            <span class="n">l_fwd_engine</span><span class="o">=</span><span class="n">l_fwd_engine</span><span class="p">,</span>
                            <span class="n">r_grpc_ip</span><span class="o">=</span><span class="n">r_grpc_ip</span><span class="p">,</span>
                            <span class="n">r_grpc_port</span><span class="o">=</span><span class="n">r_grpc_port</span><span class="p">,</span>
                            <span class="n">r_fwd_engine</span><span class="o">=</span><span class="n">r_fwd_engine</span><span class="p">,</span>
                            <span class="n">decap_sid</span><span class="o">=</span><span class="n">decap_sid</span><span class="p">,</span>
                            <span class="n">locator</span><span class="o">=</span><span class="n">locator</span>
                        <span class="p">)</span>
                    <span class="k">elif</span> <span class="n">operation</span> <span class="o">==</span> <span class="s1">&#39;del&#39;</span><span class="p">:</span>
                        <span class="c1"># TODO keep arango connection open</span>
                        <span class="c1"># Connect to ArangoDB</span>
                        <span class="n">client</span> <span class="o">=</span> <span class="n">arangodb_driver</span><span class="o">.</span><span class="n">connect_arango</span><span class="p">(</span>
                            <span class="n">url</span><span class="o">=</span><span class="n">arango_url</span><span class="p">)</span>
                        <span class="c1"># Connect to the db</span>
                        <span class="n">database</span> <span class="o">=</span> <span class="n">arangodb_driver</span><span class="o">.</span><span class="n">connect_srv6_usid_db</span><span class="p">(</span>
                            <span class="n">client</span><span class="o">=</span><span class="n">client</span><span class="p">,</span>
                            <span class="n">username</span><span class="o">=</span><span class="n">arango_user</span><span class="p">,</span>
                            <span class="n">password</span><span class="o">=</span><span class="n">arango_password</span>
                        <span class="p">)</span>
                        <span class="c1"># Save the policy to the db</span>
                        <span class="n">arangodb_driver</span><span class="o">.</span><span class="n">delete_usid_policy</span><span class="p">(</span>
                            <span class="n">database</span><span class="o">=</span><span class="n">database</span><span class="p">,</span>
                            <span class="n">key</span><span class="o">=</span><span class="n">_id</span><span class="p">,</span>
                            <span class="n">lr_dst</span><span class="o">=</span><span class="n">lr_destination</span><span class="p">,</span>
                            <span class="n">rl_dst</span><span class="o">=</span><span class="n">rl_destination</span><span class="p">,</span>
                            <span class="n">lr_nodes</span><span class="o">=</span><span class="n">nodes_lr</span><span class="p">,</span>
                            <span class="n">rl_nodes</span><span class="o">=</span><span class="n">nodes_rl</span><span class="p">,</span>
                            <span class="n">table</span><span class="o">=</span><span class="n">table</span> <span class="k">if</span> <span class="n">table</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="n">metric</span><span class="o">=</span><span class="n">metric</span> <span class="k">if</span> <span class="n">metric</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="k">else</span> <span class="kc">None</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Unsupported operation: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">operation</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="n">InvalidConfigurationError</span><span class="p">,</span> <span class="n">NodeNotFoundError</span><span class="p">,</span>
                    <span class="n">TooManySegmentsError</span><span class="p">,</span> <span class="n">SIDLocatorError</span><span class="p">,</span> <span class="n">InvalidSIDError</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">commons_pb2</span><span class="o">.</span><span class="n">STATUS_INTERNAL_ERROR</span>
        <span class="c1"># Return the response</span>
        <span class="k">return</span> <span class="n">response</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Unsupported operation: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">operation</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">None</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, Carmine Scarpitta

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>